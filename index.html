<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Squares Pro</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f4f9;
            --text-color: #333;
            --cell-size: 65px; 
            --winner-border: #ffd700;
            --primary: #1976d2;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 340px;
            background: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .player-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            background: #fff;
        }

        .player-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1rem;
        }

        .del-btn { color: #d32f2f; cursor: pointer; font-weight: bold; padding: 5px 10px; }
        .del-btn:hover { background: #ffebee; border-radius: 4px; }

        /* --- MAIN AREA --- */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- SCOREBOARD --- */
        .scoreboard {
            background: white;
            width: 90%;
            max-width: 900px;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .team-display { display: flex; align-items: center; gap: 15px; min-width: 250px; }
        .score-big { font-size: 3.5rem; font-weight: 800; font-family: monospace; line-height: 1; }
        .controls { display: flex; gap: 5px; margin-top: 5px; }

        /* --- GRID LAYOUT --- */
        /* Wrapper for Capture */
        #capture-target {
            background: var(--bg-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .grid-area {
            display: grid;
            grid-template-columns: 60px auto; 
            grid-template-rows: 60px auto;    
            gap: 0;
            margin-bottom: 20px;
        }

        .grid-label-top {
            grid-column: 2; grid-row: 1;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; font-weight: 800; color: #444;
            text-transform: uppercase; letter-spacing: 1px;
            padding-bottom: 10px;
        }
        
        .grid-label-left {
            grid-column: 1; grid-row: 2;
            writing-mode: vertical-rl; transform: rotate(180deg);
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; font-weight: 800; color: #444;
            text-transform: uppercase; letter-spacing: 1px;
            padding-right: 10px;
            height: 100%;
        }

        .grid-container {
            grid-column: 2; grid-row: 2;
            display: grid;
            grid-template-columns: var(--cell-size) repeat(10, var(--cell-size));
            grid-template-rows: var(--cell-size) repeat(10, var(--cell-size));
            border: 4px solid #333;
            background: #333; /* Gap color */
            gap: 2px;
        }

        .cell {
            background: white;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 1.1rem;
            color: black;
            position: relative;
        }

        .cell.header {
            color: white; font-size: 1.3rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .cell.current-winner { z-index: 10; box-shadow: inset 0 0 0 6px var(--winner-border); }
        .cell.past-winner { box-shadow: inset 0 0 0 6px #d32f2f; }

        /* --- EXPORT FOOTER (Hidden usually) --- */
        #export-footer {
            display: none; /* Only visible during capture */
            width: 100%;
            max-width: 800px;
            margin-top: 20px;
            border-top: 3px solid #333;
            padding-top: 20px;
        }
        .footer-row {
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
            font-weight: bold;
            padding: 10px;
            background: white;
            border-bottom: 1px solid #eee;
        }

        /* --- UTILS --- */
        .btn { padding: 12px 20px; cursor: pointer; border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: #d32f2f; color: white; }
        .btn-success { background: #2e7d32; color: white; }
        .btn-dark { background: #333; color: white; }
        .btn-outline { background: transparent; border: 2px solid #666; color: #666; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
        
        .hidden { display: none !important; }
        
        /* Modal & Input Styles */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:100; backdrop-filter: blur(4px); }
        .modal-content { background:white; padding:40px; border-radius:12px; width:400px; text-align:center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        /* Larger Inputs */
        .modal-content input { 
            width:90%; 
            padding: 15px; 
            margin: 15px 0; 
            border: 2px solid #ccc; 
            border-radius: 8px; 
            font-size: 1.2rem; /* Bigger Font */
        }
        .modal-content input:focus { border-color: var(--primary); outline: none; }

    </style>
</head>
<body>

    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <h2 style="margin-top:0">Add Player</h2>
            <input type="text" id="new-name" placeholder="Full Name">
            <input type="text" id="new-init" placeholder="Initials (e.g. JD)" maxlength="3">
            <br><br>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addPlayer()">Add Player</button>
            </div>
        </div>
    </div>

    <div class="sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0; color: var(--primary);">üèà Squares</h2>
            <button class="btn-sm btn-outline" onclick="resetGame()">New Game</button>
        </div>
        <p style="font-size:0.8rem; color:#666; margin-bottom: 20px;">Game saves automatically.</p>
        
        <div id="setup-controls">
            <button class="btn btn-primary" style="width:100%" onclick="openModal()">+ Add Player</button>
        </div>

        <div id="player-list" class="player-list"></div>

        <div style="margin-top:20px; border-top: 1px solid #eee; padding-top: 20px;">
            <div id="team-selects">
                <label style="font-size: 0.9rem; font-weight: bold;">Top Team:</label>
                <select id="sel-top" style="width:100%; padding:10px; margin-bottom:15px; border-radius:6px; font-size:1rem;"></select>
                
                <label style="font-size: 0.9rem; font-weight: bold;">Left Team:</label>
                <select id="sel-left" style="width:100%; padding:10px; margin-bottom:15px; border-radius:6px; font-size:1rem;"></select>
                
                <button class="btn btn-success" style="width:100%; margin-top: 10px;" onclick="startGame()">START GAME</button>
            </div>

            <div id="game-controls" class="hidden">
                <button class="btn btn-dark" style="width:100%; margin-bottom:10px;" onclick="exportBoard()">üì∏ Export Board (PNG)</button>
                <button class="btn btn-danger" style="width:100%; margin-bottom:10px;" onclick="endQuarter()">End Quarter</button>
                
                <div style="font-size:0.85rem; height:150px; overflow-y:auto; background:#f0f0f0; padding:10px; border:1px solid #ddd; border-radius: 4px;">
                    <strong>Quarter Log:</strong>
                    <ul id="game-log" style="padding-left:20px; margin:5px 0;"></ul>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        
        <div id="scoreboard" class="scoreboard hidden">
            <div class="team-display">
                <div style="text-align:center;">
                    <h2 id="sb-name-top" style="margin:0; color:#555;">Team 1</h2>
                    <div class="controls">
                        <button class="btn btn-sm btn-primary" onclick="score(1, 6)">+6</button>
                        <button class="btn btn-sm btn-primary" onclick="score(1, 1)">+1</button>
                        <button class="btn btn-sm btn-primary" onclick="score(1, 3)">+3</button>
                        <button class="btn btn-sm btn-danger" onclick="score(1, -1)">-1</button>
                    </div>
                </div>
                <div id="score-top" class="score-big">0</div>
            </div>

            <div style="font-size:2.5rem; color:#ccc; font-weight:100;">VS</div>

            <div class="team-display" style="justify-content: flex-end;">
                <div id="score-left" class="score-big">0</div>
                <div style="text-align:center;">
                    <h2 id="sb-name-left" style="margin:0; color:#555;">Team 2</h2>
                    <div class="controls">
                        <button class="btn btn-sm btn-primary" onclick="score(2, 6)">+6</button>
                        <button class="btn btn-sm btn-primary" onclick="score(2, 1)">+1</button>
                        <button class="btn btn-sm btn-primary" onclick="score(2, 3)">+3</button>
                        <button class="btn btn-sm btn-danger" onclick="score(2, -1)">-1</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="capture-target">
            <div class="grid-area hidden" id="grid-wrapper">
                <div id="lbl-top" class="grid-label-top"></div>
                <div id="lbl-left" class="grid-label-left"></div>
                <div id="grid" class="grid-container">
                    </div>
            </div>

            <div id="export-footer">
                <h3 style="text-align:center; margin:0 0 10px 0;">Quarter Breakdown</h3>
                <div id="footer-content">
                    </div>
            </div>
        </div>

        <div id="setup-message" style="margin-top: 100px; color: #888; text-align:center;">
            <h1>üèà Setup Phase</h1>
            <p>Add players on the left, select teams, and click Start.</p>
        </div>

    </div>

<script>
    // --- NFL DATA ---
    const TEAMS = [
        { name: "Arizona Cardinals", color: "#97233F" }, { name: "Atlanta Falcons", color: "#A71930" },
        { name: "Baltimore Ravens", color: "#241773" }, { name: "Buffalo Bills", color: "#00338D" },
        { name: "Carolina Panthers", color: "#0085CA" }, { name: "Chicago Bears", color: "#0B162A" },
        { name: "Cincinnati Bengals", color: "#FB4F14" }, { name: "Cleveland Browns", color: "#311D00" },
        { name: "Dallas Cowboys", color: "#003594" }, { name: "Denver Broncos", color: "#FB4F14" },
        { name: "Detroit Lions", color: "#0076B6" }, { name: "Green Bay Packers", color: "#203731" },
        { name: "Houston Texans", color: "#03202F" }, { name: "Indianapolis Colts", color: "#002C5F" },
        { name: "Jacksonville Jaguars", color: "#006778" }, { name: "Kansas City Chiefs", color: "#E31837" },
        { name: "Las Vegas Raiders", color: "#000000" }, { name: "L.A. Chargers", color: "#0080C6" },
        { name: "L.A. Rams", color: "#003594" }, { name: "Miami Dolphins", color: "#008E97" },
        { name: "Minnesota Vikings", color: "#4F2683" }, { name: "New England Patriots", color: "#002244" },
        { name: "New Orleans Saints", color: "#D3BC8D" }, { name: "New York Giants", color: "#0B2265" },
        { name: "New York Jets", color: "#125740" }, { name: "Philadelphia Eagles", color: "#004C54" },
        { name: "Pittsburgh Steelers", color: "#FFB612" }, { name: "San Francisco 49ers", color: "#AA0000" },
        { name: "Seattle Seahawks", color: "#002244" }, { name: "Tampa Bay Buccaneers", color: "#D50A0A" },
        { name: "Tennessee Titans", color: "#0C2340" }, { name: "Washington Commanders", color: "#5A1414" }
    ];

    // --- STATE ---
    const STORAGE_KEY = 'squares_pro_save';
    
    let state = {
        players: [],
        gridOwners: [], 
        topNums: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
        leftNums: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9],
        gameStarted: false,
        scoreT: 0,
        scoreL: 0,
        teamTIdx: 0,
        teamLIdx: 1,
        quarter: 1,
        pastWinners: [],
        quarterLogs: [] // { q: 1, winner: 'JD', score: '7-0' }
    };

    // --- INIT ---
    window.onload = () => {
        // Populate Selects
        const sT = document.getElementById('sel-top');
        const sL = document.getElementById('sel-left');
        TEAMS.forEach((t, i) => {
            sT.add(new Option(t.name, i));
            sL.add(new Option(t.name, i));
        });
        sL.selectedIndex = 1; 

        // Load Auto-Save
        const saved = localStorage.getItem(STORAGE_KEY);
        if(saved) {
            try {
                state = JSON.parse(saved);
                restoreGame();
            } catch(e) { console.error("Save corrupted", e); }
        }

        renderPlayerList();
    };

    function saveGame() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function resetGame() {
        if(!confirm("Start a brand new game? All current data will be lost.")) return;
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
    }

    function restoreGame() {
        // Restore Inputs
        document.getElementById('sel-top').selectedIndex = state.teamTIdx;
        document.getElementById('sel-left').selectedIndex = state.teamLIdx;

        // Restore UI State
        if(state.gameStarted) {
            document.getElementById('setup-controls').classList.add('hidden');
            document.getElementById('team-selects').classList.add('hidden');
            document.getElementById('setup-message').classList.add('hidden');
            
            document.getElementById('game-controls').classList.remove('hidden');
            document.getElementById('scoreboard').classList.remove('hidden');
            document.getElementById('grid-wrapper').classList.remove('hidden');
            
            updateTeamLabels();
            renderActiveGrid();
            highlightWinner();
            
            // Restore Logs
            const logList = document.getElementById('game-log');
            logList.innerHTML = '';
            state.quarterLogs.forEach(log => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>Q${log.q}:</strong> ${log.score} &rarr; ${log.winner}`;
                logList.appendChild(li);
            });
        }
    }

    // --- PLAYERS ---
    function openModal() { document.getElementById('modal').classList.remove('hidden'); document.getElementById('new-name').focus(); }
    function closeModal() { document.getElementById('modal').classList.add('hidden'); }
    
    function addPlayer() {
        const name = document.getElementById('new-name').value.trim();
        const init = document.getElementById('new-init').value.trim().toUpperCase();
        if(!name || !init) return alert("Enter Name and Initials");
        
        state.players.push({ name, init, squaresAssigned: 0 });
        document.getElementById('new-name').value = '';
        document.getElementById('new-init').value = '';
        
        closeModal();
        renderPlayerList();
        saveGame();
    }

    function removePlayer(idx) {
        state.players.splice(idx, 1);
        renderPlayerList();
        saveGame();
    }

    function renderPlayerList() {
        const list = document.getElementById('player-list');
        list.innerHTML = '';
        state.players.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = 'player-item';
            
            let content = `<span><strong>${p.init}</strong> - ${p.name}</span>`;
            
            if(!state.gameStarted) {
                content += `<span class="del-btn" onclick="removePlayer(${i})">&times;</span>`;
            } else {
                content += `<span style="background:#eee; padding:5px 10px; border-radius:6px; font-weight:bold;">${p.squaresAssigned}</span>`;
            }
            
            div.innerHTML = content;
            list.appendChild(div);
        });
    }

    // --- GRID RENDERING ---
    function createCell(type, text, bg) {
        const div = document.createElement('div');
        div.className = `cell ${type}`;
        div.textContent = text;
        if(bg) div.style.backgroundColor = bg;
        return div;
    }

    function renderActiveGrid() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';

        const tColor = TEAMS[state.teamTIdx].color;
        const lColor = TEAMS[state.teamLIdx].color;

        // 1. Corner
        grid.appendChild(createCell('header', `Q${state.quarter > 4 ? 'OT' : state.quarter}`, '#222'));

        // 2. Top Headers
        state.topNums.forEach(n => grid.appendChild(createCell('header', n, tColor)));

        // 3. Rows
        for(let r=0; r<10; r++) {
            grid.appendChild(createCell('header', state.leftNums[r], lColor));

            for(let c=0; c<10; c++) {
                const idx = r * 10 + c;
                const ownerIdx = state.gridOwners[idx];
                const div = document.createElement('div');
                div.className = 'cell';
                div.id = `c-${r}-${c}`;
                
                if(ownerIdx !== null && ownerIdx !== 'OPEN') {
                    div.textContent = state.players[ownerIdx].init;
                } else if (ownerIdx === 'OPEN') {
                    div.style.background = '#eee';
                }

                if(state.pastWinners.includes(idx)) {
                    div.classList.add('past-winner');
                }
                
                grid.appendChild(div);
            }
        }
    }

    // --- GAME LOGIC ---
    function startGame() {
        if(state.players.length === 0) return alert("Add players first!");
        if(!confirm("Start Game? This locks the player list.")) return;

        state.teamTIdx = document.getElementById('sel-top').selectedIndex;
        state.teamLIdx = document.getElementById('sel-left').selectedIndex;
        
        // Randomization
        const totalSquares = 100;
        const numPlayers = state.players.length;
        const squaresPerPlayer = Math.floor(totalSquares / numPlayers);
        
        let pool = [];
        state.players.forEach((p, idx) => {
            p.squaresAssigned = squaresPerPlayer;
            for(let i=0; i<squaresPerPlayer; i++) pool.push(idx);
        });
        while(pool.length < 100) pool.push('OPEN');

        // Shuffle
        for (let i = pool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [pool[i], pool[j]] = [pool[j], pool[i]];
        }

        state.gridOwners = pool;
        state.gameStarted = true;

        // UI Transition
        document.getElementById('setup-controls').classList.add('hidden');
        document.getElementById('team-selects').classList.add('hidden');
        document.getElementById('setup-message').classList.add('hidden');
        
        document.getElementById('game-controls').classList.remove('hidden');
        document.getElementById('scoreboard').classList.remove('hidden');
        document.getElementById('grid-wrapper').classList.remove('hidden');

        updateTeamLabels();
        renderActiveGrid();
        renderPlayerList();
        highlightWinner();
        saveGame();
    }

    function updateTeamLabels() {
        const t = TEAMS[state.teamTIdx];
        const l = TEAMS[state.teamLIdx];

        document.getElementById('lbl-top').textContent = t.name;
        document.getElementById('lbl-top').style.color = t.color;
        
        document.getElementById('lbl-left').textContent = l.name;
        document.getElementById('lbl-left').style.color = l.color;

        document.getElementById('sb-name-top').textContent = t.name;
        document.getElementById('score-top').style.color = t.color;
        document.getElementById('score-top').textContent = state.scoreT;

        document.getElementById('sb-name-left').textContent = l.name;
        document.getElementById('score-left').style.color = l.color;
        document.getElementById('score-left').textContent = state.scoreL;
    }

    function score(team, val) {
        if(team===1) state.scoreT = Math.max(0, state.scoreT + val);
        else state.scoreL = Math.max(0, state.scoreL + val);
        updateTeamLabels();
        highlightWinner();
        saveGame();
    }

    function highlightWinner() {
        document.querySelectorAll('.current-winner').forEach(e => e.classList.remove('current-winner'));
        const col = state.scoreT % 10;
        const row = state.scoreL % 10;
        const cell = document.getElementById(`c-${row}-${col}`);
        if(cell) cell.classList.add('current-winner');
    }

    function endQuarter() {
        const col = state.scoreT % 10;
        const row = state.scoreL % 10;
        const idx = row * 10 + col;

        state.pastWinners.push(idx);

        const ownerIdx = state.gridOwners[idx];
        let winnerName = "OPEN";
        if(ownerIdx !== 'OPEN') winnerName = `${state.players[ownerIdx].name}`;
        
        const logData = {
            q: state.quarter,
            score: `${TEAMS[state.teamTIdx].name} ${state.scoreT} - ${TEAMS[state.teamLIdx].name} ${state.scoreL}`,
            winner: winnerName
        };
        state.quarterLogs.push(logData);
        
        const li = document.createElement('li');
        li.innerHTML = `<strong>Q${logData.q}:</strong> ${logData.score} &rarr; ${logData.winner}`;
        document.getElementById('game-log').appendChild(li);

        state.quarter++;
        renderActiveGrid(); 
        highlightWinner();
        saveGame();
    }

    // --- EXPORT TO PNG ---
    function exportBoard() {
        const target = document.getElementById('capture-target');
        const footer = document.getElementById('export-footer');
        const footerContent = document.getElementById('footer-content');
        
        // 1. Populate Footer
        footerContent.innerHTML = '';
        if(state.quarterLogs.length === 0) {
            footerContent.innerHTML = '<div style="padding:10px; text-align:center;">Game in Progress - No Quarters Finished</div>';
        } else {
            state.quarterLogs.forEach(log => {
                const row = document.createElement('div');
                row.className = 'footer-row';
                row.innerHTML = `<span>Q${log.q} Winner: ${log.winner}</span> <span>${log.score}</span>`;
                footerContent.appendChild(row);
            });
        }

        // 2. Show footer for capture
        footer.style.display = 'block';

        // 3. Capture
        html2canvas(target, { scale: 2 }).then(canvas => {
            const link = document.createElement('a');
            link.download = `FootballSquares_Q${state.quarter}.png`;
            link.href = canvas.toDataURL();
            link.click();
            
            // 4. Hide footer again
            footer.style.display = 'none';
        });
    }

</script>
</body>
</html>
